# 飞书文档访问修复总结

## 问题描述
用户报告在AI测试用例生成器的背景知识功能中无法打开飞书文档，特别是wiki类型的文档链接。

## 问题分析
经过调试发现以下问题：

1. **凭证配置缺失**: 飞书API需要应用ID和应用密钥，但用户界面未配置
2. **Wiki文档支持不完整**: 代码只支持docx文档，不支持wiki文档的特殊处理
3. **错误处理不够友好**: API失败时没有清晰的错误提示

## 修复内容

### 1. 扩展文档类型支持
- 修改正则表达式，支持 `docx`、`wiki`、`docs` 三种文档类型
- 添加wiki文档的特殊处理逻辑

### 2. Wiki文档API处理
Wiki文档需要两步处理：
1. 先调用 `/open-apis/wiki/v2/spaces/get_node` 获取实际文档token
2. 再用实际文档token获取文档内容

### 3. 改进错误处理
- 提供更清晰的错误信息
- 当API失败时自动回退到网页抓取
- 在侧边栏显示配置状态

### 4. 调试支持
- 创建了调试脚本 `debug_feishu.py` 用于测试API访问
- 添加了详细的调试日志

## 使用方法

### 配置飞书API凭证
1. 访问飞书开发者后台：https://open.feishu.cn/app
2. 创建应用，获取 App ID 和 App Secret
3. 在应用中，进入"权限管理"，添加以下权限：
   - `docx:document` (文档权限)
   - `wiki:wiki` (知识库权限)
4. 在Streamlit应用的侧边栏"飞书API配置"部分输入凭证

### 支持的文档类型
- **标准文档**: `https://mi.feishu.cn/docx/文档ID`
- **Wiki文档**: `https://mi.feishu.cn/wiki/文档ID`
- **其他文档**: `https://mi.feishu.cn/docs/文档ID`

### 背景知识使用
1. 在侧边栏"背景知识"部分输入飞书文档URL
2. 点击"加载链接内容"
3. 系统会自动通过API获取文档内容并作为背景知识

## 测试验证

### URL解析测试 ✅
- Wiki文档URL正确识别和解析
- 文档ID正确提取
- Wiki标识正确设置

### 错误处理测试 ✅
- 无凭证时显示友好提示
- API失败时自动回退网页抓取
- 调试模式提供详细日志

## 后续建议

1. **权限配置**: 确保飞书应用有足够的权限访问目标文档
2. **文档共享**: 确保文档已共享给应用或应用有足够权限
3. **网络连接**: 确保服务器可以访问飞书API
4. **调试模式**: 启用调试模式查看详细错误信息

## 文件修改列表
- `test.py`: 主应用逻辑修复
- `debug_feishu.py`: 新增调试脚本
- `test_url_parsing.py`: 新增URL解析测试脚本